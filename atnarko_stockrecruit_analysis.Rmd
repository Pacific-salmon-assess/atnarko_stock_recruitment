---
title: "Stock-recruitment analysis for Atnarko sockeye"
author: "D. Greenberg"
date: "10/25/2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r load,  include=FALSE}
library(here);library(ggplot2);library(rstan)
```
```{r, functions}
source(here('code','stan_functions.R'))
source(here('code','lfo_stan_functions.R'))
source(here('code','util_functions.R'))
source(here('code','RP_functions.R'))
```

Plot recruits as a function of escapement, by brood year.


```{r, data}
SR_data <- read.csv(here('data','Atnarko_SK_RS.csv'))
names(SR_data)[1]=c('broodyear')
SR_data$logR_S<- log(SR_data$recruits/SR_data$spawners)
SR_data<- SR_data[complete.cases(SR_data$logR_S),]
ggplot(SR_data, aes(spawners, recruits)) +
  geom_point(aes(colour = broodyear),size=2.5) +
  scale_colour_viridis_c()

```
Figure 1. Recruitment as a function of spawner escapement for Atnarko sockeye from brood year cohorts 1972 to 2016.

\pagebreak
We will use the Atnarko sockeye stock-recruitment time-series to compare 8 different stock-recruitment model forms that represent time-invariant (models 1 & 2), time-varying (models 3 - 5), or regime-shift (models 6 - 8) model types.

Model 1 - Static Ricker curve

Model 2 - Autocorrelated Ricker curve

Model 3 - Time-varying productivity Ricker curve

Model 4 - Time-varying capacity Ricker curve

Model 5 - Time-varying prod. & cap. Ricker curve

Model 6 - Regime-shift productivity Ricker curve

Model 7 - Regime-shift capacity Ricker curve

Model 8 - Regime-shift prod. & cap. Ricker curve

We start by competing each of these models in their accuracy in predicting productivity (log Recruits per Spawner) 1-year ahead using an iterative cross-validation approach (implemented with functions from samEst), starting from the 16th brood cohort and onwards.


```{r, echo=FALSE,results='hide'}
load("C:/Users/greenbergda/Desktop/atnarko/data/logliks.RData")
```

Using the out-of-sample log-likelihood estimates, we can compare the Bayesian model weights for each model set. First finding the highest likelhood prediction window (ie 1-year back parameters, last 3-year average of parameters, or last 5-year average of parameters). We can assess model weights using the full predictive dataset, or dropping the 10/20% of hardest to assess years as the full model likelihoods may be highly influenced by the most challenging to predict observations.

```{r, model selection}
  wm2=which.max(apply(ll2,1,sum)) #select best likelihood from different timeframes (1-y back, 3-y back, 5-y back)
  wm3=which.max(apply(ll3,1,sum))#best fit for model 3
  wm4=which.max(apply(ll4,1,sum))#best fit for model 4
  wm5=which.max(apply(ll5,1,sum)) #best fit for model 5
  wm6=which.max(apply(ll6,1,sum)) #best fit for model 6
  wm7=which.max(apply(ll7,1,sum)) #best fit for model 7
  wm8=which.max(apply(rbind(ll8_1,ll8_2),1,sum)) #best fit for model 8 (two combinations of higher alpha, lower cap; higher alpha, higher cap)
  if(wm8<4){
    mod_loglik=rbind(ll1,ll2[wm2,],ll3[wm3,],ll4[wm4,],ll5[wm5,],ll6[wm6,],ll7[wm7,],ll8_1[wm8,])
    rownames(mod_loglik[[i]])[1:8]=paste('m',seq(1:8),sep='');rownames(mod_loglik[[i]])[8]='m8_1'
  }
  if(wm8>4){
    mod_loglik=rbind(ll1,ll2[wm2,],ll3[wm3,],ll4[wm4,],ll5[wm5,],ll6[wm6,],ll7[wm7,],ll8_2[wm8-4,])
    rownames(mod_loglik)[1:8]=paste('m',seq(1:8),sep='');rownames(mod_loglik)[8]='m8_2'
  }

  model_weights(mod_loglik)
  model_weights(mod_loglik,type='d90')
  model_weights(mod_loglik,type='d80')
```

Using the 1-year out-of-sample predictive accuracy from 1987 to 2016, the best supported model was time-varying capacity (model 4), with regime-shift capacity or regime-shift productivity and capacity having the next levels of support based on the 90% and 80% highest accuracy observations, respectively. 

Note that the time-varying beta model (m4) actually had considerable convergence problems fitting to the full data - which can happen when data are clustered near the origin of the stock-recruitment plot - so we will proceed with model 7 instead (regime-shift capacity), which has similar conceptual linkages to model 4. Note - that these are all based on statistical fits, and may or may not actually represent a true shift in stock carrying capacity.


```{r, echo=FALSE,results='hide'}
m7f=sr_mod(type='hmm',par='b',loglik=F)

fit_7f= rstan::sampling(m7f, 
                        data = list(N=nrow(SR_data),
                                    L=max(SR_data$broodyear)-min(SR_data$broodyear)+1,
                                    ii=SR_data$broodyear-min(SR_data$broodyear)+1,
                                    R_S =SR_data$logR_S,
                                    S=SR_data$spawners,
                                    K=2,
                                    alpha_dirichlet=c(1,1)),
                        control = list(adapt_delta = 0.95,max_treedepth=20), warmup = 200, chains = 6, iter = 700)

d=extract(fit_7f)

```


```{r, figure 2}
x_new=seq(min(SR_data$spawners),max(SR_data$spawners),length.out=200)
alpha.m=median(d$log_a)
beta.m.1=apply(d$b,2,median)[1]
beta.m.2=apply(d$b,2,median)[2]

y_pred1=exp(alpha.m-beta.m.1*x_new)*x_new
y_pred2=exp(alpha.m-beta.m.2*x_new)*x_new

pred_df=data.frame(x_new,y_pred1,y_pred2)

SR_data$p.High_Cap=apply(d$gamma[,,1],2,median)
gamma_d=data.frame(prob=apply(d$gamma[,,1],2,median),l90=apply(d$gamma[,,1],2,quantile,0.1),u90=apply(d$gamma[,,1],2,quantile,0.9),by=SR_data$broodyear)

ggplot(SR_data, aes(spawners, recruits)) +
  geom_point(aes(colour = broodyear),size=2.5) +
  scale_colour_viridis_c()+geom_line(data=pred_df,aes(x=x_new,y=y_pred1))+geom_line(data=pred_df,aes(x=x_new,y=y_pred2))
```

Figure 2. Predicted stock-recruitment functions for Atnarko sockeye for each regime (high and low capacity regimes), with observations coloured by brood cohort year.

\pagebreak
```{r, figure3}
ggplot(SR_data, aes(x=spawners,y=recruits)) +
  geom_point(aes(colour = p.High_Cap),size=2.5) +
  scale_colour_viridis_c()+geom_line(data=pred_df,aes(x=x_new,y=y_pred1))+geom_line(data=pred_df,aes(x=x_new,y=y_pred2))+ geom_text(data=SR_data, aes(x=spawners, y=recruits, label=broodyear),hjust=1.2, vjust=0.8,size=2.5)
```
Figure 3. Predicted stock-recruitment functions for Atnarko sockeye for each regime (high and low capacity regimes), with observations coloured by the median probability of being in the 'High Capacity' regime (Yellow indicating high probability and purple low probability, respectively).

```{r, figure4}
ggplot(gamma_d, aes(by, prob)) +
  geom_point(aes(colour = prob),size=3) +
  scale_colour_viridis_c() + geom_ribbon(aes(ymin =l90, ymax =u90), alpha = 0.2) +xlab('Brood year')+ylab('Prob. of High Capacity Regime') + geom_hline(yintercept=0.5) 
```
Figure 4. Estimated probabilities of each brood year cohort being in the 'high capacity' regime state from 1972 to 2016, conversely, low probabilities indicate a high probability of being in a 'low capacity' regime state. Shaded area represents the 90% confidence intervals in the state probabilities.

\pagebreak
## Reference points

$S_max$: The spawner escapement that maximizes recruitment under either regime are indicated in the histograms. Note that esitmates are truncated here (for visual purposes) at the 90% upper estimate to remove extremely high estimates on the tails of the parameters for each regime.

```{r, S_max}
hist(d$S_max[(d$S_max[,1]<quantile(d$S_max[,1],0.9)),1],main='S_max, High Capacity Regime',xlab='spawners');hist(d$S_max[(d$S_max[,2]<quantile(d$S_max[,2],0.9)),2],main='S_max, Low Capacity Regime',xlab='spawners')
```

$S_{msy}$: Spawner escapement that would produce (theoretical) maximum sustainable yield (MSY) from each regime. Note that esitmates are truncated here (for visual purposes) at the 90% upper estimate to remove extremely high estimates on the tails of the parameters for each regime.

```{r, S_msy}
hist(d$S_msy[(d$S_msy[,1]<quantile(d$S_msy[,1],0.9)),1],main='S_msy, High Capacity Regime',xlab='spawners')
hist(d$S_msy[(d$S_msy[,2]<quantile(d$S_msy[,2],0.9)),2],main='S_msy, Low Capacity Regime',xlab='spawners')

```
\pagebreak

```{r, U_msy}
hist(d$U_msy,main='U_msy',xlab='exploitation rate')
```

$U_{msy}$: The corresponding maximum sustainable annual exploitation rate is shared between both regimes, since it depends on the shared productivity parameter.
