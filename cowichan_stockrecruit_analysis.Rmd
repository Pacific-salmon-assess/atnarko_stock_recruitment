---
title: "Stock-recruitment analysis for Atnarko sockeye"
author: "D. Greenberg"
date: "6/6/2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r load,  include=FALSE}
library(here)
```
```{r, functions}
source(here('code','stan_functions.R'))
source(here('code','lfo_stan_functions.R'))
source(here('code','RP_functions.R'))
```


```{r, data}
SR_data <- read.csv(here('data','Atnarko_SK_RS.csv'))
SR_data$logR_S<- log(SR_data$recruits/SR_data$spawners)
SR_data<- SR_data[complete.cases(SR_data$logR_S),]
plot(recruits~spawners,data=SR_data,bty='l',pch=21)

```

Using the brood tables for Cowichan chinook cohorts from 1989 to 2016, we can model the relationship between spawners (escapement) and subsequent total returns of adults among years. This can provide information on stock reference points and expectations. I used a generalized least squares approach to include autocorrelation in the residuals of the productivity relationship over time - this accounts for whether consecutive cohorts have similar recruitment through time. We can also compare this to a model assuming independent residuals (the key parameter estimates may differ based on this assumption).
```{r, define stan models}
m_ricker=lm(logR_S~spawners,data=SR_data)
m_ricker_ar1=gls(logR_S~spawners,data=SR_data,correlation = corAR1(form = ~ 1),method='ML')
summary(m_ricker) #Ricker stock-recruit model with independent residuals
m_ricker_ar1 #Ricker stock-recruit model with autocorrelated residuals
```
The correlation between successive residuals in the spawner-recruit relationship ('Phi') is fairly high (~0.6), so we will proceed with the model including autocorrelated residuals in productivity. We will also propagate uncertainty in the parameters.

```{r, params}
sim_pars=MASS::mvrnorm(1000,mu=m_ricker_ar1$coefficients,Sigma=vcov(m_ricker_ar1))
sim_pars[,2]=abs(sim_pars[,2])
newd=data.frame(spawners=seq(0,25000));p=predict(m_ricker_ar1,newdata=newd);rec=exp(p)*newd$spawners
lims_rec=par_predict_rec(sim_pars,s=newd$spawners)
lims_prod=par_predict_prod(sim_pars,s=newd$spawners)
```

## Plot stock-recruitment relationship

```{r, figure1}
plot(recruits~spawners,data=SR_data,bty='l',ylab='Recruits',xlab='Spawners',type='n')
#poly_x=c(s,rev(s))
#poly_y=c(lims_r[,2],rev(lims_r[,1]))
#polygon(poly_x, poly_y, col = adjustcolor('dodgerblue4', alpha = 0.4), border=NA) # Add uncertainty polygon
lines(lims_rec[,1]~newd$spawners,lty=3)
lines(lims_rec[,2]~newd$spawners,lty=3)
cols=wes_palette("Zissou1",length(seq(0,1,by=0.15)), type="continuous")
br=quantile(SR_data$broodyear,probs=seq(0,1,by=0.15))
col_points=adjustcolor(cols[findInterval(SR_data$broodyear,br)],alpha.f=0.8)
points(recruits~spawners,data=SR_data,cex=1.2,pch=21,bg=col_points)
text(x=SR_data$spawners,y=jitter(SR_data$recruits,300),SR_data$broodyear,cex=0.7)
legend(x=19000,y=max(SR_data$recruits),pch=c(21,21,21,21),pt.bg=c(col_points[1],col_points[11],col_points[21],col_points[27]),c('1989','1999','2009','2016'),title='Cohort Year',bty='n')

 
lines(seq(0:25000)~seq(0:25000),col='red')
lines(rec~newd$spawners,lwd=2)
```
Visualization of the stock-recruitment relationship, with each cohort coloured by brood year. Dashed lines indicate 90% confidence interval for the stock-recruitment relationship and the red line indicates replacement (1:1 recruits-to-spawners).

```{r, figure2}
plot(exp(logR_S)~spawners,data=SR_data,bty='l',ylab='Recruits per spawner',xlab='Spawners',type='n')
abline(h=1,col='red')
points(exp(logR_S)~spawners,data=SR_data,cex=1.2,pch=21,bg=col_points)
newd=data.frame(spawners=seq(0,25000));p=predict(m_ricker_ar1,newdata=newd)
lines(lims_prod[,1]~newd$spawners,lty=3)
lines(lims_prod[,2]~newd$spawners,lty=3)
lines(exp(p)~newd$spawners,lwd=2)
legend(x=19000,y=5.5,pch=c(21,21,21,21),pt.bg=c(col_points[1],col_points[11],col_points[21],col_points[27]),c('1989','1999','2009','2016'),title='Cohort Year',bty='n')
text(x=SR_data$spawners,y=jitter(exp(SR_data$logR_S),1),SR_data$broodyear,cex=0.7)
```

Productivity (recruits per spawner) as a function of number of spawners (escapement), with each cohort coloured by brood year. Red line indicates replacement level (R/S = 1).

## Reference points
## S MSY
We can estimate the escapement that would produce maximum sustainable yield (MSY) from this relationship ($S_{msy}$), and similarly propagate the uncertainty in this metric. Shown is the point estimate and 80% range of estimates.

```{r, S_msy}
Smsy =MSY_lambert(alpha=m_ricker_ar1$coefficients[1],beta=abs(m_ricker_ar1$coefficients[2]))
Smsy_full=MSY_lambert_posterior(alpha=sim_pars[,1],beta=abs(sim_pars[,2]))
Smsy_full2=cbind(Smsy_full,sim_pars)
Smsy_full2=Smsy_full2[order(Smsy_full2[,1]),];Smsy_full2=Smsy_full2[200:800,]
hist(Smsy_full2[,1],main='Uncertainty in escapement to achieve MSY',xlab='Escapement')
abline(v=Smsy,col='red');print(Smsy)
```
## S gen
From this we can also estimate $S_{gen}$, the spawner abundance that should recover $S_msy$ in one generation in the absence of fishing under equilibrium conditions. Shown is the point estimate and 80% range of estimates.

```{r, S_gen}
Sgen=sGenSolver(theta=c(m_ricker_ar1$coefficients[1],abs(m_ricker_ar1$coefficients[2]),m_ricker_ar1$sigma),sMSY=Smsy)
Sgen_full=sGenSolver_posterior(theta_df = cbind(Smsy_full2[,2:3],rep(m_ricker_ar1$sigma,nrow(Smsy_full2))),sMSY_full = Smsy_full2[,1])
hist(Sgen_full,main='Uncertainty in S_gen',xlab='Escapement')
abline(v=Sgen,col='red');print(Sgen)
```
## U MSY
The maximum sustainable annual exploitation rate ($U_{msy}$) can be estimated based on intrinsic productivity (alpha, the intercept) from the stock-recruitment relationship.

```{r, U_msy}
U_MSY=Umsy(m_ricker_ar1$coefficients[1])
U_MSY_full=Umsy_posterior(sim_pars[,1])
U_MSY_full=U_MSY_full[U_MSY_full>0]
hist(U_MSY_full,main='Uncertainty in U_msy',xlab='Annual harvest rate')
abline(v=U_MSY,col='red');print(U_MSY)
```


Compile together reference points with 80% confidence intervals for estimates.

```{r, table}
ref_point=data.frame(metric=c('S_MSY','S_Gen','U_MSY'),est=NA,l80CI=NA,u80CI=NA)
ref_point[1,2]=Smsy;ref_point[1,3]=Smsy_full2[1];ref_point[1,4]=Smsy_full2[601]
ref_point[2,2]=Sgen;ref_point[2,3]=Sgen_full[1];ref_point[2,4]=Sgen_full[601]
ref_point[3,2]=U_MSY;ref_point[3,3]=quantile(U_MSY_full,0.2);ref_point[3,4]=quantile(U_MSY_full,0.8)
knitr::kable(ref_point)


```